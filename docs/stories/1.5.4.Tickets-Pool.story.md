# Story 1.5.4: Tickets Pool

## Status
Ready for Review

## Story
**As a** user,
**I want** a FIFO tickets pool where I can queue tickets that I'm not ready to schedule on the timeline,
**so that** I can organize my tickets in a first-in, first-out queue before committing them to specific time slots.

## Acceptance Criteria
1. Tickets pool panel is positioned below the main timeline interface and is foldable/collapsible.
2. Pool operates as a FIFO queue - newest tickets are added to the end, oldest are retrieved from the front.
3. Users can move tickets from timeline to pool via button/menu action (unscheduling them).
4. Users can move tickets from pool to timeline via button/menu action (scheduling them).
5. Within the pool, users can drag-drop to reorder tickets for priority management.
6. Pool tickets use existing visual design but indicate "unscheduled/queued" status.
7. Pool panel can be collapsed/expanded to save screen space.
8. Existing timeline-to-timeline drag-drop functionality continues unchanged.
9. **Local Testing:** Extended `./packages/testing/test-timeline-drag-drop.sh` validates pool operations and FIFO behavior.
10. **Performance:** Pool operations maintain 50ms response time, backend updates within 500ms.

## Tasks / Subtasks
- [x] **Task 1 (AC: 1, 7)**: Create collapsible tickets pool component below timeline
  - [x] Subtask 1.1: Create `TicketsPool.tsx` component in `packages/frontend/src/components/timeline/components/`
  - [x] Subtask 1.2: Implement collapsible panel using existing UI components from `packages/frontend/src/components/ui/`
  - [x] Subtask 1.3: Position pool below timeline in main Timeline component
  - [x] Subtask 1.4: Add toggle state management for expand/collapse functionality

- [x] **Task 2 (AC: 2, 6)**: Implement FIFO queue data structure and visual indicators
  - [x] Subtask 2.1: Extend Redux `timelineSlice.ts` with pool state management (FIFO queue)
  - [x] Subtask 2.2: Create pool-specific ticket rendering with "unscheduled/queued" visual indicators
  - [x] Subtask 2.3: Implement FIFO operations (add to end, retrieve from front) in Redux actions
  - [x] Subtask 2.4: Update existing ticket visual design to show pool vs timeline status

- [x] **Task 3 (AC: 3, 4)**: Implement button/menu-based ticket movement between timeline and pool
  - [x] Subtask 3.1: Add "Move to Pool" button/menu option to timeline tickets
  - [x] Subtask 3.2: Add "Schedule" button/menu option to pool tickets
  - [x] Subtask 3.3: Create ticket movement handlers that update Redux state
  - [x] Subtask 3.4: Integrate with existing timeline state management hooks

- [x] **Task 4 (AC: 5)**: Add drag-drop reordering within the pool
  - [x] Subtask 4.1: Implement internal pool drag-drop using existing drag patterns from `useTimelineDrag.ts`
  - [x] Subtask 4.2: Create pool-specific drag handlers that don't interfere with timeline drag-drop
  - [x] Subtask 4.3: Update pool order in Redux state on successful drag-drop
  - [x] Subtask 4.4: Maintain FIFO integrity while allowing manual reordering

- [x] **Task 5 (AC: 10)**: Backend API integration for pool operations
  - [x] Subtask 5.1: Extend existing ticket API endpoints in `packages/backend/src/app/tickets/tickets.controller.ts`
  - [x] Subtask 5.2: Add pool-related fields to ticket model (poolOrder, isInPool)
  - [x] Subtask 5.3: Implement optimistic updates with 50ms response time target
  - [x] Subtask 5.4: Add error handling and rollback for failed pool operations

- [x] **Task 6 (AC: 9)**: Extend existing drag-drop tests for pool functionality
  - [x] Subtask 6.1: Update `packages/testing/test-timeline-drag-drop.sh` to include pool tests
  - [x] Subtask 6.2: Add unit tests for pool component in `packages/frontend/src/components/timeline/__tests__/`
  - [x] Subtask 6.3: Test FIFO behavior, drag-drop reordering, and button-based movements
  - [x] Subtask 6.4: Validate performance requirements (50ms response, 500ms backend updates)

- [x] **Task 7 (UX Enhancement)**: Improve ticket pool user experience with tooltips and modal integration
  - [x] Subtask 7.1: Add hover tooltips to pool tickets showing detailed information
  - [x] Subtask 7.2: Remove "Move to Pool" button from ticket component hover state  
  - [x] Subtask 7.3: Add "Move to Pool" action button to ticket detail modal
  - [x] Subtask 7.4: Update pool component to use existing TimelineTooltip component

## Dev Notes

### Previous Story Insights
From Story 1.5.3 completion: Timeline drag-drop system is fully functional with sophisticated state management via `useTimelineDrag.ts` hook. The existing drag-drop patterns should be reused for pool internal reordering while avoiding conflicts with timeline operations.

### Component Architecture Context
[Source: architecture/component-architecture-integration.md#current-component-state-analysis]
- Timeline system is fully implemented with complete hook architecture
- Use existing component patterns from `packages/frontend/src/components/timeline/components/`
- Follow established Redux Toolkit patterns in `packages/frontend/src/store/slices/timelineSlice.ts`
- Integrate with current drag-drop system via `packages/frontend/src/components/timeline/hooks/useTimelineDrag.ts`

### File Locations and Project Structure
[Source: architecture/source-tree-and-module-organization.md#current-project-structure]
- **New Component**: `packages/frontend/src/components/timeline/components/TicketsPool.tsx`
- **State Management**: Extend `packages/frontend/src/store/slices/timelineSlice.ts`
- **Hook Integration**: Reference `packages/frontend/src/components/timeline/hooks/useTimelineDrag.ts`
- **Testing**: Update `packages/testing/test-timeline-drag-drop.sh` and add to `packages/frontend/src/components/timeline/__tests__/`

### Data Models and Backend Integration
[Source: architecture/data-models-and-schema-integration.md#existing-data-models]
- Ticket model already exists with proper relationships
- Add pool-related fields: `poolOrder` (Int?), `isInPool` (Boolean @default(false))
- Backend API follows NestJS patterns in `packages/backend/src/app/tickets/tickets.controller.ts`
- Use existing Prisma service patterns for database operations

### Drag-Drop Integration Strategy
[Source: architecture/component-architecture-integration.md#new-components-required]
- Pool drag-drop must be isolated from timeline drag-drop to prevent conflicts
- Reuse existing drag patterns but create separate drop zones
- Maintain existing timeline-to-timeline functionality unchanged
- Use existing Redux optimistic update patterns for performance

### Performance Requirements
- Pool operations must maintain 50ms visual response time (matching existing timeline performance)
- Backend updates within 500ms (existing API performance target)
- Follow existing performance patterns established in Epic 1 timeline implementation

### UI/UX Integration
- Use existing ticket visual design from `TicketComponent.tsx`
- Apply existing UI components from `packages/frontend/src/components/ui/`
- Follow established color coding and visual feedback patterns
- Maintain consistency with current timeline interface design

### Testing
**Testing Standards from Architecture:**
- Test file location: `packages/frontend/src/components/timeline/__tests__/TicketsPool.test.tsx`
- Update existing script: `packages/testing/test-timeline-drag-drop.sh`
- Use Jest with React Testing Library for component tests
- Follow existing testing patterns from `packages/testing/frontend/timeline-drag-drop.test.ts`
- Test FIFO queue behavior, drag-drop reordering, and performance requirements
- Validate button/menu-based ticket movements and state persistence

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-07 | 1.0 | Initial story creation with FIFO pool design | Bob (Scrum Master) |
| 2025-08-08 | 2.0 | Story implementation completed | James (Dev Agent) |

## Dev Agent Record

### Agent Model Used
Claude 3.5 Sonnet

### File List
**New Files Created:**
- `packages/frontend/src/components/timeline/components/TicketsPool.tsx` - Main pool component with FIFO UI and drag-drop
- `packages/frontend/src/components/timeline/hooks/useTicketsPool.ts` - Pool state management hook
- `packages/frontend/src/components/timeline/components/__tests__/TicketsPool.test.tsx` - Pool component tests
- `packages/frontend/src/components/timeline/hooks/useTicketsPool.test.tsx` - Pool hook tests

**Modified Files:**
- `packages/frontend/src/store/slices/timelineSlice.ts` - Added pool state management and FIFO operations
- `packages/frontend/src/components/timeline/components/Timeline.tsx` - Integrated pool component
- `packages/frontend/src/components/timeline/components/TicketComponent.tsx` - Updated to remove hover pool button and clean up unused props
- `packages/frontend/src/components/tickets/TicketDetailModal.tsx` - Added "Move to Pool" action button with pool integration
- `packages/frontend/src/components/timeline/components/index.ts` - Exported new pool component
- `packages/frontend/src/components/timeline/hooks/index.ts` - Exported pool hook
- `packages/frontend/src/app/page.tsx` - Connected pool to main timeline
- `packages/types/src/lib/timeline.types.ts` - Added pool-related props to TimelineProps
- `packages/backend/prisma/schema.prisma` - Added pool fields (poolOrder, isInPool)
- `packages/backend/src/app/tickets/tickets.controller.ts` - Added pool API endpoints
- `packages/backend/src/app/tickets/tickets.service.ts` - Added pool service methods
- `packages/backend/src/app/tickets/dto/ticket.dto.ts` - Added pool fields to DTOs
- `packages/testing/test-timeline-drag-drop.sh` - Extended to include pool tests

### Debug Log References
- Successfully implemented all 6 main tasks and 24 subtasks
- Pool component integrates seamlessly with existing timeline drag-drop system
- FIFO queue operations work correctly with Redux state management
- Backend API provides complete CRUD operations for pool functionality
- Drag-drop reordering within pool works independently from timeline drag-drop

### Completion Notes
**✅ All Acceptance Criteria Met:**
1. ✅ Tickets pool panel positioned below timeline and collapsible
2. ✅ FIFO queue functionality implemented with visual indicators
3. ✅ Button-based movement from timeline to pool 
4. ✅ Button-based scheduling from pool to timeline
5. ✅ Drag-drop reordering within pool for priority management
6. ✅ Pool tickets show "QUEUED" status with visual differentiation
7. ✅ Pool panel collapse/expand functionality implemented
8. ✅ Existing timeline-to-timeline drag-drop unchanged
9. ✅ Extended test suite covers pool operations and FIFO behavior
10. ✅ Performance targets met (50ms UI response, 500ms backend updates)

**Key Features Implemented:**
- Complete FIFO queue with visual priority indicators
- Seamless integration with existing timeline system
- Independent drag-drop system for pool reordering
- Full backend API support with error handling
- Comprehensive test coverage for all functionality
- Optimistic updates for responsive user experience
- **NEW**: Hover tooltips on pool tickets showing detailed ticket information
- **NEW**: "Move to Pool" action moved from ticket hover to ticket detail modal
- **IMPROVED**: Cleaner timeline interface without pool button clutter on tickets

### Change Log
**August 9, 2025 - UX Enhancements (Task 7)**
- **ENHANCED**: Added hover tooltips to pool tickets using existing TimelineTooltip component with higher z-index for proper visibility
- **IMPROVED**: Removed "Move to Pool" button from ticket hover state for cleaner timeline interface  
- **ADDED**: "Move to Pool" action button in ticket detail modal for better user workflow, conditionally hidden for tickets already in pool
- **INTEGRATED**: Pool component now shows detailed ticket information on hover with tooltips
- **FIXED**: Pool tickets are now clickable to open ticket detail modal
- **FIXED**: When scheduling tickets from pool, they now default to current time with 1-hour duration instead of original time
- **ENHANCED**: TimelineTooltip now uses z-[100] to ensure visibility above pool components
