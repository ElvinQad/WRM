# Story 1.5: Monthly Data Aggregation

## Status
Draft

## Story
**As a** system,
**I want** to provide aggregated ticket data for monthly timeline views,
**so that** monthly view performance is optimized and displays appropriate summary information.

## Acceptance Criteria
1. Backend provides aggregated API endpoints for monthly data (e.g., ticket counts, duration summaries by day/week).
2. Monthly view loads aggregated data instead of detailed ticket data.
3. Aggregated data includes sufficient information for meaningful monthly visualization.
4. Data aggregation maintains user privacy and security constraints.

## Tasks / Subtasks
- [ ] **Task 1 (AC: 1)**: Create `TicketAggregationService` in the backend.
  - [ ] Subtask 1.1: Implement daily metrics calculation (total tickets, duration, completion rate, productivity scoring).
  - [ ] Subtask 1.2: Implement time distribution analysis (morning/afternoon/evening breakdown).
  - [ ] Subtask 1.3: Implement significant ticket selection logic (identify most important tickets per day).
  - [ ] Subtask 1.4: Implement busy level calculation algorithm (low/medium/high based on activity).
- [ ] **Task 2 (AC: 1)**: Add aggregated data endpoint to `TicketsController`.
  - [ ] Subtask 2.1: Create `/api/tickets/aggregated` GET endpoint with month range parameters.
  - [ ] Subtask 2.2: Integrate endpoint with `TicketAggregationService` for monthly view data.
- [ ] **Task 3 (AC: 2, 3)**: Update frontend to use aggregated data for monthly view.
  - [ ] Subtask 3.1: Modify `useTimeline` hook to detect monthly view and call aggregated endpoint.
  - [ ] Subtask 3.2: Create monthly calendar grid component with day cells showing metrics and busy levels.
  - [ ] Subtask 3.3: Implement hover tooltips for detailed daily breakdowns.
  - [ ] Subtask 3.4: Implement click-to-drill-down navigation to daily view.
- [ ] **Task 4 (AC: 4)**: Implement security and privacy measures.
  - [ ] Subtask 4.1: Ensure aggregated endpoints respect user authentication and data access permissions.
  - [ ] Subtask 4.2: Validate that aggregated data doesn't expose sensitive information inappropriately.

## Dev Notes

### Previous Story Insights
This story addresses the data model gap identified during Story 1.1 preparation. It ensures that monthly view has appropriate data architecture from the start.

### Data Models
- **Monthly Aggregated Data Structure**: 
  ```json
  {
    "monthlyView": {
      "period": "2025-07",
      "granularity": "daily",
      "days": [
        {
          "date": "2025-07-01",
          "metrics": {
            "totalTickets": 6,
            "totalDuration": 360,
            "completed": 4,
            "productivity": 0.67,
            "busyLevel": "high"
          },
          "timeDistribution": {
            "morning": { "tickets": 2, "duration": 120 },
            "afternoon": { "tickets": 3, "duration": 180 },
            "evening": { "tickets": 1, "duration": 60 }
          },
          "typeBreakdown": {
            "meeting": 2,
            "task": 3,
            "personal": 1
          },
          "significantTickets": [
            {
              "id": "ticket_123",
              "title": "Important Meeting",
              "startTime": "09:00",
              "duration": 90,
              "type": "meeting",
              "status": "completed"
            }
          ]
        }
      ]
    }
  }
  ```
- **API Response Format**: Monthly aggregation with daily breakdown and drill-down capability
[Source: Monthly View Design Analysis - Hybrid Approach]

### API Specifications
- **New Endpoint**: `GET /api/tickets/aggregated`
- **Parameters**: 
  - `startDate`: Beginning of month range
  - `endDate`: End of month range  
  - `granularity`: 'daily' or 'weekly' aggregation
- **Authentication**: Must use existing Supabase Auth integration
[Source: docs/brownfield-architecture/3-proposed-architecture.md#new-modules]

### Component Specifications
- **`TicketAggregationService`**: New service at `packages/backend/src/app/tickets/ticket-aggregation.service.ts`
  - Methods: `calculateDailyMetrics()`, `analyzeTimeDistribution()`, `selectSignificantTickets()`, `calculateBusyLevel()`
- **`TicketsController`**: Enhancement to existing controller at `packages/backend/src/app/tickets/tickets.controller.ts`
- **`useTimeline` hook**: Enhancement to existing hook at `packages/frontend/src/components/timeline/hooks/useTimeline.ts`
- **`MonthlyCalendarView`**: New component for monthly grid display with day cells and drill-down capability
- **UI Pattern**: Calendar grid (7x5) with day cells showing busy level, metrics, and hover details
[Source: docs/brownfield-architecture/4-source-tree-integration.md, Monthly View Design Analysis]

### File Locations
- Backend service: `packages/backend/src/app/tickets/ticket-aggregation.service.ts`
- Controller enhancement: `packages/backend/src/app/tickets/tickets.controller.ts`
- Frontend hook: `packages/frontend/src/components/timeline/hooks/useTimeline.ts`
- Timeline component: `packages/frontend/src/components/timeline/components/Timeline.tsx`

### Testing Requirements
- Unit tests for `TicketAggregationService` aggregation logic
- Integration tests for `/api/tickets/aggregated` endpoint
- Frontend tests for monthly view data loading behavior
- Performance tests to ensure aggregated data improves monthly view performance
[Source: docs/brownfield-architecture/2-architectural-goals-constraints.md]

### Technical Constraints
- Must use existing NestJS backend and Next.js frontend
- Must maintain Supabase Auth integration
- Aggregation must not compromise user data privacy
- Performance must be optimized for large datasets
[Source: docs/brownfield-architecture/1-introduction.md, docs/brownfield-architecture/2-architectural-goals-constraints.md]

## Change Log

| Date       | Version | Description                     | Author        |
|------------|---------|--------------------------------|---------------|
| 2025-07-24 | 1.0     | Initial story created from Sprint Change Proposal | Sarah (Product Owner) |

## Dev Agent Record
*This section will be populated by the development agent during implementation.*

## QA Results
*This section will be populated by the QA agent after the story is implemented.*
