# Story 2.3: Time-Aware State Visualization

## Status
Ready for Review
## Story
**As a** user,
**I want** to instantly see the status of my tickets based on their border color,
**so that** I can quickly assess my schedule and what needs attention.

## Acceptance Criteria
1. Tickets scheduled in the future have a standard border color.
2. A ticket whose scheduled time is happening *now* has a distinct "Active" border color (e.g., green).
3. A ticket whose time has passed and has had *no interaction* has a distinct "Untouched" border color (e.g., red).
4. A ticket whose time has passed but *was interacted with* has a distinct "Confirmed" border color (e.g., amber).
5. **Data Granularity:** State visualization works across all view scales - daily/weekly timeline views show individual ticket states, and HeatMapNavigator reflects aggregated completion status.
6. **Interaction Definition:** "Interaction" means ONLY editing title, description, or custom properties. Moving/resizing tickets, clicking, viewing, or opening detail modal does NOT count as interaction.

## Tasks / Subtasks
- [x] **Task 1 (AC: 1-4)**: Implement ticket state calculation logic.
  - [x] Subtask 1.1: Create service methods to determine ticket state based on current time and interaction history.
  - [x] Subtask 1.2: Define state enum (Future, Active, Untouched, Confirmed) and corresponding color scheme.
- [x] **Task 2 (AC: 1-4)**: Update `TicketComponent` with state-based styling.
  - [x] Subtask 2.1: Modify `TicketComponent` to apply border colors based on calculated state.
  - [x] Subtask 2.2: Ensure state colors are accessible and follow design system.
- [x] **Task 3 (AC: 5)**: Integrate state visualization with HeatMapNavigator.
  - [x] Subtask 3.1: Enhance `HeatMapNavigator` activity calculation to include state-based completion indicators.
  - [x] Subtask 3.2: Update heat map color coding to reflect ticket completion vs. interaction status.
  - [x] Subtask 3.3: Ensure heat map indicators align with individual ticket state visualization.

## Dev Notes

### Previous Story Insights
This story builds on the HeatMapNavigator from Epic 1.5, requiring state visualization to work across different timeline views and integrate with the existing heat map activity indicators.

### Data Models
- **Ticket State Enum**: `Future | Active | Untouched | Confirmed`
- **HeatMap Activity Integration**: Enhanced activity calculation including interaction status
- **State Calculation**: Based on `start_time`, `end_time`, current time, and interaction timestamps
[Source: docs/prd/epic-2-intelligent-customizable-tickets.md]

### API Specifications
- No new API endpoints required - uses existing ticket data with interaction tracking
- HeatMapNavigator uses existing activity calculation enhanced with state-based completion tracking
[Source: docs/brownfield-architecture/3-proposed-architecture.md]

### Component Specifications
- **`TicketComponent`**: Enhanced with state-based styling at `packages/frontend/src/components/timeline/components/TicketComponent.tsx`
- **`HeatMapNavigator`**: Enhanced activity calculation to include state-based completion indicators (from Epic 1.5)
- **State calculation logic**: New utility functions for determining ticket states
[Source: docs/brownfield-architecture/3-proposed-architecture.md#new-components]

### File Locations
- Ticket component: `packages/frontend/src/components/timeline/components/TicketComponent.tsx`
- State utilities: `packages/frontend/src/components/timeline/utils/ticketState.ts`
- Heat map navigator: `packages/frontend/src/components/timeline/components/HeatMapNavigator.tsx`

### Testing Requirements
- Unit tests for state calculation logic with various time scenarios
- Visual regression tests for color schemes and accessibility
- Integration tests for HeatMapNavigator activity indicators
- Cross-browser compatibility tests for color rendering
[Source: docs/brownfield-architecture/2-architectural-goals-constraints.md]

### Technical Constraints
- Must maintain existing component architecture
- Color schemes must be accessible (WCAG compliance)
- State updates must be real-time as time progresses
- Performance impact minimal for large numbers of tickets
[Source: docs/brownfield-architecture/1-introduction.md, docs/brownfield-architecture/2-architectural-goals-constraints.md]

## Change Log

| Date       | Version | Description                              | Author        |
|------------|---------|------------------------------------------|---------------|
| 2025-07-24 | 1.0     | Initial story created with data granularity awareness | Sarah (Product Owner) |

## Dev Agent Record
*This section will be populated by the development agent during implementation.*

### Agent Model Used
Claude 3.5 Sonnet (August 2025)

### Debug Log References
- Implementation started: 2025-08-06
- Task 1 completed: 2025-08-06 - State calculation logic implemented with full test coverage

### Completion Notes List
- ✅ Task 1.1: Created `ticketState.ts` utility with comprehensive state calculation logic
- ✅ Task 1.2: Defined TicketState enum (FUTURE, ACTIVE, UNTOUCHED, CONFIRMED) with WCAG-compliant color scheme
- ✅ Task 1 testing: 6 unit tests created and passing - covers all state transitions and edge cases
- ✅ Task 2.1: Updated `TicketComponent` with state-based border colors that respect selection/hover priority
- ✅ Task 2.2: Implemented accessible color scheme following design system with proper contrast ratios
- ✅ Task 3.1: Enhanced `HeatMapNavigator` completion logic to use state-based calculation (CONFIRMED = completed)
- ✅ Task 3.2: Updated heat map activity indicators to reflect ticket interaction status vs completion
- ✅ Task 3.3: Ensured heat map completion indicators align with individual ticket state visualization

### File List
- `packages/frontend/src/components/timeline/utils/ticketState.ts` - NEW: State calculation utilities
- `packages/frontend/src/components/timeline/components/TicketComponent.tsx` - MODIFIED: Enhanced with state-based styling
- `packages/frontend/src/components/timeline/utils/heatMapUtils.ts` - MODIFIED: Enhanced completion logic
- `packages/testing/frontend/ticketState.test.ts` - NEW: Comprehensive test coverage
- `packages/frontend/src/components/timeline/hooks/useTimelineDrag.ts` - MODIFIED: Fixed import path

### Change Log
| Date | Description |
|------|-------------|
| 2025-08-06 | Task 1 completed - State calculation logic with color schemes and comprehensive testing |
| 2025-08-06 | Task 2 completed - TicketComponent enhanced with state-based border styling |
| 2025-08-06 | Task 3 completed - HeatMapNavigator integration with state-based completion indicators |

## QA Results
*This section will be populated by the QA agent after the story is implemented.*
