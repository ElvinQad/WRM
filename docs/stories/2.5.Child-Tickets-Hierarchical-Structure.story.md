# Story 2.5: Child Tickets & Hierarchical Structure

## Status
Approved

## Story
**As a** user,
**I want** to create child tickets under parent tickets to break down complex tasks,
**so that** I can organize related sub-tasks and track progress hierarchically.

## Acceptance Criteria
1. Tickets have an "Add Child Ticket" option that creates a sub-ticket.
2. Parent tickets visually indicate the number of child tickets (e.g., badge, expand/collapse).
3. **Child Inheritance Rules:**
   - Child tickets inherit: ticket type, custom field definitions, and selected custom property values (user-configurable)
   - Child tickets do NOT inherit: specific time slots, completion status, recurrence patterns
   - Users can choose which custom properties to inherit during child creation
4. **Parent Completion Logic:**
   - Parent shows completion progress: "3 of 5 children complete" with visual progress indicator
   - Parent auto-completion is user-configurable per parent ticket (on/off toggle)
   - When auto-completion enabled: parent auto-completes when ALL children are complete
   - Manual parent completion allowed regardless of child status
   - Parent completion doesn't affect child completion status
5. **Local Testing:** CLI command `deno test packages/testing/backend/ticket-hierarchy.test.ts` validates parent-child relationships.
6. **Validation:** Support up to 3 levels of nesting, prevent circular dependencies.
7. **Performance:** Hierarchical views load within 500ms for tickets with up to 20 children.

## Tasks / Subtasks

- [ ] Task 1: Extend Database Schema for Hierarchical Structure (AC: 1, 3, 6)
  - [ ] Subtask 1.1: Add `parentTicketId` field to Ticket model in Prisma schema
  - [ ] Subtask 1.2: Add self-referential relationship for parent-child hierarchy
  - [ ] Subtask 1.3: Add `nestingLevel` field to track hierarchy depth (max 3 levels)
  - [ ] Subtask 1.4: Create database migration with proper indexes for performance
  - [ ] Subtask 1.5: Add validation constraints to prevent circular dependencies

- [ ] Task 2: Implement Backend API for Hierarchical Operations (AC: 1, 4, 6)
  - [ ] Subtask 2.1: Create child ticket creation endpoint `POST /api/tickets/:id/children`
  - [ ] Subtask 2.2: Implement hierarchy validation service to prevent circular references
  - [ ] Subtask 2.3: Add hierarchy-aware ticket retrieval with nested children
  - [ ] Subtask 2.4: Implement parent completion status calculation and progress tracking
  - [ ] Subtask 2.5: Add configurable auto-completion logic with user preferences
  - [ ] Subtask 2.6: Add bulk operations for hierarchy management

- [ ] Task 3: Create Frontend Child Ticket Management Components (AC: 1, 2, 3, 4)
  - [ ] Subtask 3.1: Enhance `TicketDetailModal` with "Add Child Ticket" button
  - [ ] Subtask 3.2: Create `ChildTicketList` component for displaying hierarchy
  - [ ] Subtask 3.3: Add visual indicators (badges, progress bars, expand/collapse) for parent tickets
  - [ ] Subtask 3.4: Implement child ticket creation form with selective property inheritance
  - [ ] Subtask 3.5: Add hierarchy navigation breadcrumbs
  - [ ] Subtask 3.6: Create parent auto-completion settings UI

- [ ] Task 4: Implement Hierarchical Timeline Integration (AC: 2, 7)
  - [ ] Subtask 4.1: Enhance timeline to show parent-child relationships visually
  - [ ] Subtask 4.2: Add expand/collapse functionality for ticket hierarchies in timeline
  - [ ] Subtask 4.3: Implement efficient hierarchy loading with pagination
  - [ ] Subtask 4.4: Add performance optimization for large hierarchies (20+ children)
  - [ ] Subtask 4.5: Integrate with existing drag-drop while maintaining hierarchy

- [ ] Task 5: Create Comprehensive Testing Suite (AC: 5, 6, 7)
  - [ ] Subtask 5.1: Write unit tests for hierarchy validation logic
  - [ ] Subtask 5.2: Create integration tests for parent-child API operations
  - [ ] Subtask 5.3: Implement performance tests for large hierarchy loading
  - [ ] Subtask 5.4: Add edge case tests for maximum nesting and circular prevention
  - [ ] Subtask 5.5: Create frontend component tests for hierarchy UI

## Dev Notes

### Previous Story Insights
Building on the Repeatable Tickets implementation from Story 2.4, the hierarchical structure must work seamlessly with recurring ticket patterns. Parent tickets with recurrence patterns should maintain hierarchy relationships across all generated instances, and child tickets may have independent recurrence patterns from their parents.

### Data Models
**Required Prisma Schema Extensions:**
```prisma
model Ticket {
  // Existing fields from previous stories...
  id              String   @id @default(uuid())
  title           String
  description     String?
  userId          String
  typeId          String
  startTime       DateTime
  endTime         DateTime
  status          TicketStatus @default(FUTURE)
  customProperties Json?
  isRecurring     Boolean @default(false)
  recurrenceId    String?
  parentTicketId  String?
  recurrenceRule  String?
  
  // NEW - Hierarchical structure fields
  parentTicketId   String? // Self-referential parent relationship
  nestingLevel     Int @default(0) // Track depth (0=root, max=3)
  childOrder       Int? // Order within siblings
  
  // NEW - Enhanced completion tracking
  autoCompleteOnChildrenDone Boolean @default(false) // User preference
  childCompletionCount       Int @default(0) // Cached count for performance
  totalChildCount           Int @default(0) // Cached count for performance
  
  // Relationships
  user            User @relation(fields: [userId], references: [id])
  type            TicketType @relation(fields: [typeId], references: [id])
  parentTicket    Ticket? @relation("TicketHierarchy", fields: [parentTicketId], references: [id])
  childTickets    Ticket[] @relation("TicketHierarchy")
  
  @@index([parentTicketId])
  @@index([nestingLevel])
  @@index([userId, parentTicketId]) // Composite index for user's hierarchies
  @@map("tickets")
}
```
[Source: docs/architecture/data-models-and-schema-integration.md]

### API Specifications
**New Hierarchical Endpoints:**
```typescript
// POST /api/tickets/:id/children
interface CreateChildTicketRequest {
  title: string;
  description?: string;
  inheritCustomProperties?: string[]; // Array of property keys to inherit
  startTime?: string;
  endTime?: string;
}

// GET /api/tickets/:id/hierarchy
interface HierarchyResponse {
  ticket: TicketWithHierarchy;
  children: TicketWithHierarchy[];
  completionProgress: {
    completed: number;
    total: number;
    percentage: number;
  };
  maxDepth: number;
}

// PUT /api/tickets/:id/completion-settings
interface CompletionSettingsRequest {
  autoCompleteOnChildrenDone: boolean;
}

// PUT /api/tickets/:id/move-hierarchy
interface MoveHierarchyRequest {
  newParentId?: string; // null to make root-level
  validateNesting: boolean;
}

// GET /api/tickets/:id/completion-progress
interface CompletionProgressResponse {
  completedChildren: number;
  totalChildren: number;
  percentage: number;
  canAutoComplete: boolean;
}
```
[Source: docs/architecture/api-design-and-integration.md#integration-with-existing-api-patterns]

### Component Specifications
**Frontend Component Extensions:**
- **`TicketDetailModal`**: Enhanced at `packages/frontend/src/components/tickets/TicketDetailModal.tsx` with "Add Child Ticket" button and hierarchy navigation
- **`ChildTicketList`**: New component at `packages/frontend/src/components/tickets/ChildTicketList.tsx` for hierarchical display
- **`HierarchyBreadcrumb`**: New component at `packages/frontend/src/components/tickets/HierarchyBreadcrumb.tsx` for navigation
- **Timeline Integration**: Enhanced timeline components to show parent-child visual connections and expand/collapse functionality
[Source: docs/architecture/source-tree-and-module-organization.md#current-project-structure-updated-august-2025]

### File Locations
**Backend Files:**
- `packages/backend/src/app/tickets/dto/hierarchy.dto.ts` - Hierarchy-specific DTOs
- `packages/backend/src/app/tickets/services/hierarchy.service.ts` - Hierarchy validation and operations
- `packages/backend/src/app/tickets/controllers/tickets.controller.ts` - Enhanced with hierarchy endpoints
- `packages/backend/prisma/migrations/` - Schema migration for hierarchy fields

**Frontend Files:**
- `packages/frontend/src/components/tickets/ChildTicketList.tsx` - Child ticket management UI
- `packages/frontend/src/components/tickets/HierarchyBreadcrumb.tsx` - Navigation component
- `packages/frontend/src/components/tickets/CompletionProgressIndicator.tsx` - Progress visualization
- `packages/frontend/src/components/tickets/PropertyInheritanceSelector.tsx` - Selective inheritance UI
- `packages/frontend/src/store/slices/hierarchySlice.ts` - Hierarchy state management
- `packages/frontend/src/components/timeline/components/HierarchyIndicator.tsx` - Timeline visual enhancements

### Technical Constraints
- Must maintain compatibility with existing recurrence patterns from Story 2.4
- Follow existing JWT authentication middleware patterns for all hierarchy operations
- Use current Prisma service injection patterns established in tickets module
- Maximum nesting level of 3 to prevent performance issues and complexity
- Circular dependency validation required at both API and database levels
- Performance requirement: hierarchy loading under 500ms for 20+ children
[Source: docs/architecture/api-design-and-integration.md#integration-with-existing-api-patterns]

### Project Structure Alignment
All new files align with established module structure in `packages/backend/src/app/tickets/` for backend services and `packages/frontend/src/components/tickets/` for UI components. Hierarchy state management follows existing Redux patterns in `packages/frontend/src/store/slices/`.

### Detailed Business Logic Specifications

**Inheritance Rules Implementation:**
1. **Always Inherit**: Ticket type, custom field definitions from ticket type
2. **User-Selectable Inheritance**: Custom property values (checkbox UI during child creation)
3. **Never Inherit**: startTime, endTime, completion status, recurrence patterns, parentTicketId
4. **Default Values**: Child tickets get default values from ticket type for non-inherited properties

**Completion Logic Implementation:**
1. **Progress Calculation**: Real-time calculation based on child completion status
2. **Auto-Completion Trigger**: Only when `autoCompleteOnChildrenDone = true` AND all children complete
3. **Manual Override**: Users can manually complete/uncomplete parents regardless of children
4. **Performance Optimization**: Use cached counts (`childCompletionCount`, `totalChildCount`) updated via triggers
5. **UI Updates**: Progress bars show "3 of 5 complete (60%)" with visual indicators

**Recurrence + Hierarchy Interaction:**
- Parent recurring + Child non-recurring: Each parent instance gets independent child copies
- Parent non-recurring + Child recurring: Multiple recurring children under one parent
- Both recurring: Each parent instance gets each child instance (cross-product)
- Child creation on recurring instance: Applies only to that specific instance unless explicitly propagated

## Testing
**Test File Location:** `packages/testing/backend/ticket-hierarchy.test.ts`
**Testing Framework:** Deno test runner with Prisma test database
**Test Categories:**
- Unit tests for hierarchy validation algorithms (circular dependency prevention)
- Integration tests for parent-child API operations with authentication
- Performance tests for hierarchy loading with 20+ children (under 500ms requirement)
- Edge case tests for maximum nesting levels and boundary conditions
- Frontend component tests for hierarchy UI and navigation
[Source: docs/architecture/testing-strategy-integration.md]

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-10 | 1.0 | Initial story creation | Scrum Master Bob |

## Dev Agent Record

### Agent Model Used
_This section will be populated by the development agent during implementation_

### Debug Log References
_Debug logs and traces will be recorded here during development_

### Completion Notes
_Implementation notes and issues will be documented here_

### File List
_Files created, modified, or affected during implementation will be listed here_

## QA Results
_QA review results will be populated here after implementation_
