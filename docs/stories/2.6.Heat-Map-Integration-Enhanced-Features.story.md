# Story 2.6: Heat Map Integration with Enhanced Ticket Features

## Status
Draft

## Story
**As a** user,
**I want** the heat map to accurately reflect all ticket enhancements (recurring patterns, hierarchical completion, and enhanced activity types),
**so that** I can get a complete visual overview of my productivity across all my complex ticket relationships and patterns.

## Acceptance Criteria
1. **Recurring Ticket Support**: Heat map shows aggregated activity from both parent recurring tickets and their instances, with parent tickets contributing to activity only when instances exist.
2. **Hierarchical Completion Integration**: Parent tickets contribute to heat map activity based on their child completion progress (e.g., 3 of 5 children complete = 60% contribution).  
3. **Enhanced Activity Types**: Heat map distinguishes between different activity types: direct completion, hierarchical completion, recurring completion, and mixed activity patterns.
4. **Visual Enhancement**: Heat map uses enhanced color schemes and intensity levels to represent the complexity of mixed activity types (recurring + hierarchical).
5. **Performance Optimization**: Heat map calculations handle complex ticket relationships within existing performance targets (300ms render, 100ms updates).
6. **Real-time Synchronization**: Heat map updates immediately when recurring instances are created, child tickets are completed, or hierarchical relationships change.
7. **Data Accuracy**: Heat map activity metrics correctly aggregate across all ticket relationship types without double-counting or missing activities.

## Tasks / Subtasks

- [ ] **Task 1 (AC: 1, 2)**: Enhance Heat Map Activity Calculation Logic
  - [ ] Subtask 1.1: Extend `ActivityCalculationService` to handle recurring ticket parent-instance relationships
  - [ ] Subtask 1.2: Implement hierarchical completion aggregation for parent tickets based on child progress
  - [ ] Subtask 1.3: Add logic to prevent double-counting activity between parents and children/instances
  - [ ] Subtask 1.4: Create weighted activity calculation for partial hierarchical completion
  - [ ] Subtask 1.5: Update existing activity date calculation to handle complex ticket relationships

- [ ] **Task 2 (AC: 3, 4)**: Implement Enhanced Activity Type Classification
  - [ ] Subtask 2.1: Create new activity type enum: `DIRECT`, `HIERARCHICAL`, `RECURRING`, `MIXED`
  - [ ] Subtask 2.2: Implement activity type detection logic based on ticket relationships
  - [ ] Subtask 2.3: Design enhanced color schemes for mixed activity visualization
  - [ ] Subtask 2.4: Add intensity calculations for complex activity patterns
  - [ ] Subtask 2.5: Update heat map tooltip to show activity type breakdown

- [ ] **Task 3 (AC: 5, 6)**: Optimize Performance for Complex Relationships  
  - [ ] Subtask 3.1: Implement efficient caching for hierarchical completion calculations
  - [ ] Subtask 3.2: Add incremental updates for recurring instance creation
  - [ ] Subtask 3.3: Optimize database queries to fetch related tickets in single operations
  - [ ] Subtask 3.4: Add performance monitoring for complex heat map calculations
  - [ ] Subtask 3.5: Implement cache invalidation strategies for real-time updates

- [ ] **Task 4 (AC: 6, 7)**: Integrate with Enhanced Ticket State Management
  - [ ] Subtask 4.1: Connect heat map updates to recurring ticket instance generation events
  - [ ] Subtask 4.2: Hook into hierarchical completion events from parent-child relationships  
  - [ ] Subtask 4.3: Update Redux timeline slice to trigger heat map recalculation on relationship changes
  - [ ] Subtask 4.4: Implement real-time event handling for complex ticket state changes
  - [ ] Subtask 4.5: Add data validation to ensure activity aggregation accuracy

- [ ] **Task 5 (AC: 1-7)**: Create Comprehensive Testing Suite
  - [ ] Subtask 5.1: Write unit tests for enhanced activity calculation with recurring tickets
  - [ ] Subtask 5.2: Create integration tests for hierarchical completion aggregation
  - [ ] Subtask 5.3: Add performance tests for complex ticket relationship scenarios
  - [ ] Subtask 5.4: Implement visual regression tests for enhanced color schemes
  - [ ] Subtask 5.5: Create end-to-end tests for real-time heat map synchronization

## Dev Notes

### Previous Story Insights
This story builds on the successful completion of Stories 2.3 (Time-Aware State Visualization), 2.4 (Repeatable Tickets), and integrates with the approved Story 2.5 (Child Tickets & Hierarchical Structure). The heat map currently uses `TicketState.CONFIRMED` for completion calculation from Story 2.3, but needs enhancement to handle the complex relationships introduced in Stories 2.4 and 2.5.

### Data Models
**Enhanced Activity Data Structure (Building on Existing):**
```typescript
// Enhancement of existing ActivityData interface
interface EnhancedActivityData extends ActivityData {
  activityTypes: {
    direct: number;        // Direct ticket completions
    hierarchical: number;  // Parent completions via child progress
    recurring: number;     // Recurring instance completions  
    mixed: number;         // Complex combinations
  };
  hierarchicalProgress: {
    parentCount: number;          // Number of parent tickets
    childCompletionRate: number;  // Average child completion rate
    weightedContribution: number; // Weighted activity contribution
  };
  recurringMetrics: {
    instanceCount: number;        // Number of recurring instances
    parentPatternCount: number;   // Number of recurring patterns
    instanceCompletionRate: number; // Instance completion rate
  };
}
```

**Ticket Relationship Types (From Stories 2.4 & 2.5):**
```typescript
interface TicketRelationships {
  isRecurringParent: boolean;
  isRecurringInstance: boolean;
  hasChildTickets: boolean;
  childCompletionCount: number;
  totalChildCount: number;
  nestingLevel: number;
}
```
[Source: docs/architecture/data-models-and-schema-integration.md, docs/stories/2.4.Repeatable-Tickets.story.md, docs/stories/2.5.Child-Tickets-Hierarchical-Structure.story.md]

### API Specifications
**Enhanced Heat Map Data Endpoint:**
```typescript
// Enhancement of existing heat map data API
// GET /api/tickets/heat-map-data
interface EnhancedHeatMapResponse {
  activities: EnhancedActivityData[];
  relationshipSummary: {
    recurringPatterns: number;
    totalInstances: number;
    hierarchicalTickets: number;
    maxNestingLevel: number;
  };
  performanceMetrics: {
    calculationTime: number;
    ticketCount: number;
    relationshipComplexity: number;
  };
}
```

**Integration with Existing Recurring/Hierarchical APIs:**
- Leverage existing recurrence endpoints from Story 2.4: `/api/tickets/recurrence/:id`
- Use hierarchical endpoints from Story 2.5: `/api/tickets/:id/hierarchy`
- Follow existing JWT authentication middleware patterns
- Maintain existing error response formats
[Source: docs/architecture/api-design-and-integration.md#integration-with-existing-api-patterns, docs/stories/2.4.Repeatable-Tickets.story.md, docs/stories/2.5.Child-Tickets-Hierarchical-Structure.story.md]

### Component Specifications
**Enhanced Heat Map Components:**
- **`HeatMapNavigator`**: Located at `packages/frontend/src/components/timeline/components/HeatMapNavigator.tsx` - enhance with complex activity visualization
- **`EnhancedActivityCalculationService`**: New service at `packages/frontend/src/components/timeline/utils/enhancedHeatMapUtils.ts`
- **`ActivityTypeIndicator`**: New component for activity type visualization in heat map tooltips
- **Integration Points**: Enhanced `useHeatMapNavigation` hook with relationship-aware caching
[Source: docs/architecture/source-tree-and-module-organization.md#current-project-structure-updated-august-2025]

### File Locations
**New Files:**
- `packages/frontend/src/components/timeline/utils/enhancedHeatMapUtils.ts` - Enhanced activity calculation
- `packages/frontend/src/components/timeline/components/ActivityTypeIndicator.tsx` - Activity type visualization
- `packages/frontend/src/components/timeline/types/enhancedActivity.ts` - Enhanced type definitions

**Modified Files:**
- `packages/frontend/src/components/timeline/utils/heatMapUtils.ts` - Integrate with enhanced calculations
- `packages/frontend/src/components/timeline/components/HeatMapNavigator.tsx` - Add enhanced visualization support
- `packages/frontend/src/components/timeline/hooks/useHeatMapNavigation.ts` - Enhanced caching and update logic
- `packages/frontend/src/store/slices/timelineSlice.ts` - Add enhanced activity state management

### Testing Requirements
**Test File Locations:**
- `packages/testing/frontend/enhanced-heatmap-activity.test.tsx` - Enhanced activity calculation tests
- `packages/testing/frontend/heatmap-recurring-integration.test.tsx` - Recurring ticket integration tests  
- `packages/testing/frontend/heatmap-hierarchical-integration.test.tsx` - Hierarchical completion tests
- `packages/testing/performance/complex-heatmap-performance.test.ts` - Performance tests for complex relationships

**Testing Framework:** Deno test runner with React Testing Library for components
**Performance Requirements:** All tests must validate 300ms render and 100ms update targets with complex ticket relationships
**Integration Testing:** Tests must verify correct integration with existing recurrence and hierarchy systems
[Source: docs/architecture/testing-strategy-integration.md]

### Technical Constraints
- Must maintain backward compatibility with existing heat map functionality from Story 1.5.1
- Performance targets must be maintained: 300ms render, 100ms updates (from Story 1.5.1)
- Cannot break existing time-aware state visualization from Story 2.3
- Must correctly integrate with on-demand instance generation from Story 2.4
- Must support hierarchical completion aggregation planned in Story 2.5
- Color schemes must remain WCAG compliant while supporting enhanced activity types
- Cache invalidation must be efficient to prevent performance degradation
[Source: docs/architecture/technical-debt-and-known-issues.md, docs/stories/1.5.1.Heat-Map-Navigation.story.md, docs/stories/2.3.Time-Aware-State-Visualization.story.md]

### Project Structure Alignment
All enhancements align with established module structure:
- Backend services in `packages/backend/src/app/tickets/`
- Frontend components in `packages/frontend/src/components/timeline/`
- Shared types in `packages/types/src/lib/`
- Tests in `packages/testing/frontend/` and `packages/testing/performance/`
[Source: docs/architecture/source-tree-and-module-organization.md#current-project-structure-updated-august-2025]

### Integration Complexity Considerations
**Recurring Ticket Integration:**
- Parent tickets should only contribute to heat map when they have active instances
- Instance completions aggregate to parent activity contribution
- On-demand instance generation triggers heat map cache invalidation
- Recurrence patterns affect activity prediction and visualization

**Hierarchical Completion Integration:**
- Parent completion contributes based on child completion percentage
- Child completions don't double-count with parent activity
- Nested hierarchies (up to 3 levels) require weighted activity calculations
- Auto-completion settings affect activity contribution timing

**Mixed Pattern Complexity:**
- Recurring parents with hierarchical children require complex aggregation
- Multiple activity types on same date need visual distinction
- Cache strategies must handle interdependent relationship updates
- Real-time updates must maintain consistency across relationship types

## Testing
**Test Standards from Architecture:**
- Use Deno test runner for backend integration tests with complex ticket relationships
- Follow existing React Testing Library patterns for frontend component testing
- Include comprehensive performance benchmarks for enhanced calculations
- Test heat map accuracy with various combinations of recurring and hierarchical tickets
- Verify real-time update synchronization across all ticket relationship types
- Validate color accessibility with enhanced activity type visualization
[Source: docs/architecture/testing-strategy-integration.md]

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-10 | 1.0 | Initial story creation for heat map integration with enhanced ticket features | Scrum Master Bob |

## Dev Agent Record

### Agent Model Used
_This section will be populated by the development agent during implementation_

### Debug Log References
_Debug logs and traces will be recorded here during development_

### Completion Notes
_Implementation notes and issues will be documented here_

### File List
_Files created, modified, or affected during implementation will be listed here_

## QA Results
_QA review results will be populated here after implementation_
